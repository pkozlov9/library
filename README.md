# Тестовое задание "Библиотека компании" на Yii2
## Требования к выполнению тестового задания:
1.&nbsp;Разработать код  с использованием Yii2.

2.&nbsp;Сделать прототип приложения, готовый для установки на сервер.

## Задачи:
1.&nbsp;Напишите DDL для базы "Библиотека Компании".

База должна содержать следующие таблицы:
  + Книга (название, дата создания записи, дата изменения);
  + Авторы (имя, дата создания записи, дата изменения);
  + Читатели (имя, дата создания записи, дата изменения).

Дамп должен быть готов к использованию в «боевой» выкладке.

2.&nbsp;Используя фреймворк Yii2 реализуйте CRUD сценарии для работы с базой "Библиотека Компании".

3.&nbsp;Создайте контроллер отчета, реализующий следующие сценарии:
  + Вывод списка книг, находящихся на руках у читателей, и имеющих не менее трех со-авторов;
  + Вывод списка авторов, чьи книги в данный момент читает более трех читателей;
  + Вывод пяти случайных книг.

При реализации учесть, что таблица книг содержит более 60 млн записей, а таблица авторов от 25 млн.

4.&nbsp;Залейте исходный код на ваш аккаунт Github, предоставьте доступ для клонирования проекта.

## Решение:
[lb_structure.sql](data/lb_structure.sql) - дамп БД: структура таблиц;</br>
[lb_data.sql](data/lb_data.sql) - дамп БД: сгенерированные данные;</br>
[benerator_lb_book.xml](config/benerator/benerator_lb_book.xml) и [benerator_lb_reader.xml](config/benerator/benerator_lb_reader.xml) - конфигурационные файлы benerator'а;</br>
[yii-test2.doc](docs/yii-test2.doc) - исходный текст задания;</br>
[answers.txt](docs/answers.txt)- ответы на вопросы и комментарии.

1.&nbsp;Считаем сколько места на диске займёт спроектированная БД:

```
lb_reader

rd_id                  BIGINT       8 байт
rd_full_name           CHAR(255)  256 байт
rd_date                DATETIME     8 байт
rd_created_at          DATETIME     8 байт
rd_updated_at          DATETIME     8 байт

итого                             288 байт
25 000 000 записей               6.07 гигабайт

lb_writer

wt_id                  BIGINT       8 байт
wt_full_name           CHAR(255)  256 байт
wt_date                DATETIME     8 байт
wt_reader_counter      INT          4 байта
wt_created_at          DATETIME     8 байт
wt_updated_at          DATETIME     8 байт

итого                             292 байт
25 000 000 записей               6.79 гигабайт

lb_book

bk_id                  BIGINT       8 байт
bk_rd_id               BIGING       8 байт
bk_title               CHAR(255)  256 байт
bk_date                DATETIME	    8 байт
bk_writer_counter      INT          4 байта
bk_created_at          DATETIME     8 байт
bk_updated_at          DATETIME     8 байт

итого                             300 байт
60 000 000 rows                 16.76 гигабайт

lb_writer_book

wb_wt_id               BIGINT       8 байт
wb_bk_id               BIGINT       8 байт

итого                              16 байт
60 000 000 записей               0.89 гигабайт

всего                           29.57 гигабайт
```

Учитывая индексы и рост данных, даже если объём данных вырастет в 10 раз 295 GB вполне уместятся на один сервер, поэтому шардирование не применяем, ограничиваемся партиционированием. Я использовал партиционирование во всех таблицах по id как самый простой быстрореализуемый вариант. В зависимости от будущего интерефейса сайта и соответственно будущих запросов к БД можно изменить параметры партиционирования. Чтобы проверить уникальность данных в каждой таблице ввёл дату рождения/издания, т к сгенерировать несколько миллионов просто уникальных имен/названий задача непростая. 25 и 60 млн записей сгенерировал но в дамп включать не стал, ограничился 10 тысячами. Конфиг бенератора и процедуры включил в репозиторий и дамп. Консистентность данных поддерживается триггерами.

2.&nbsp;При решении подобных задач, я обычно реализую представления в БД и CRUD в Yii у меня генерируется очень быстро
автоматически практически без правок PHP кода. В этот раз так делать не стал чтобы продемонстрировать умение работать
со стандартными средствами Yii (ActiveRecord, классами GridView, DetailView и т. д.).

3.&nbsp;Запросы согласно моей структе БД:

  + SELECT bk_id, bk_title, bk_date, bk_writer_counter FROM `lb_book` WHERE bk_rd_id IS NOT NULL AND
bk_writer_counter >= 3;

  + SELECT wt_id, wt_full_name, wt_date, wt_reader_counter FROM `lb_writer` WHERE wt_reader_counter > 3;

  + CALL lb_random_book(5);

В хранимой процедуре `lb_random_book` реализован следующий алгоритм:

  + a.&nbsp;Смотрим текущее значение auto_increment в таблице с книгами;

  + б.&nbsp;Генерируем 5 случайных целых чисел в диапазоне от 1 до значения auto_increment'а;

  + в.&nbsp;Выбираем из таблицы книг строки с id равным целым числам которые мы сгенерировали в п. б;

  + г.&nbsp;Если в п. в мы получили меньше 5 строк повторяем все действия начиная с п. б, накапливаем найденные книги пока
не наберём нужное количество - 5.

Можно оптимизировать генерируя в п. б. не 5 случайных id'шников а например 100. Предложенное решение будет работать
быстро пока INSERT'ов в табицу с книгами было больше чем DELETE'ов и в ней большое количество записей.
Например при тестировании на 10000 строк простой ORDER BY RAND() LIMIT 5 значительно обыгрывал мой агоритм по времени,
однако на 60 млн. записей я так и не дождался пока выполнится ORDER BY RAND(), а моя хранимая процедура по прежнему
выдаёт результат за несколько миллисекунд. 

# INSTALLATION

### Установка через composer

Склонируйте репозиторий http://github.com/pkozlov9/library.git в папку проекта.

Установите необходимые компоненты командой:

`php composer.phar install`

Проверьте зависимости командой:

`php requirements.php`

Создайте новую БД для проекта, например `library`.

Залейте дам со структурой таблиц командой:

`mysql -u root -p -D library < data/lb_structure.sql`

При необходимости залейте дам с тестовыми данными командой:

`mysql -u root -p -D library < data/lb_data.sql`

Установите права доступа к файлам следующими командами:

```
sudo chmod 0777 runtime web/assets
sudo chmod 0755 yii
```

# CONFIGURATION

Создайте локальный конфигурационный файл `config/local.php`.

### База данных

Пропишите в `config/local.php` константы для подключения к созданной БД:

```php
define('DB_HOST',   'localhost');
define('DB_NAME',   'library');
define('DB_USER',   'root');
define('DB_PASS',   '');
```

### Production/Development

По умолчанию проект настроен для работы на Production сервере, для разработки необходимо переопределить константы в `config/local.php`:

```php
define('YII_DEBUG', true);
define('YII_ENV',   'dev');
```
